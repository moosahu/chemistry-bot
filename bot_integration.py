#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Ø¯Ù…Ø¬ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª
ÙŠØ³ØªØ®Ø¯Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ handlers.admin_tools.email_notification
"""

import os
import logging
import glob
from telegram import Update
from telegram.ext import ContextTypes, CommandHandler
from weekly_report import WeeklyReportGenerator, WeeklyReportScheduler

logger = logging.getLogger(__name__)

def find_database_file():
    """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"""
    possible_paths = [
        "database/bot_stats.db",
        "bot_stats.db", 
        "database/*.db",
        "*.db"
    ]
    
    for pattern in possible_paths:
        files = glob.glob(pattern)
        if files:
            return files[0]
    
    logger.warning("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
    return None

def setup_reporting_system():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©"""
    try:
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db_path = find_database_file()
        if not db_path:
            logger.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return None
        
        logger.info(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {db_path}")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙ„Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø¨Ø¯ÙˆÙ† email_config)
        report_generator = WeeklyReportGenerator(db_path)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        scheduler = WeeklyReportScheduler(report_generator)
        
        logger.info("ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­")
        return scheduler
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}")
        return None

async def generate_report_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø£Ù…Ø± Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±ÙŠ"""
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
        user_id = update.effective_user.id
        is_admin = False
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø©
        admin_id = os.getenv("ADMIN_USER_ID")
        if admin_id and str(user_id) == admin_id:
            is_admin = True
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if not is_admin:
            try:
                db_manager = context.bot_data.get("DB_MANAGER")
                if db_manager and hasattr(db_manager, 'is_user_admin'):
                    is_admin = db_manager.is_user_admin(user_id)
            except:
                pass
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ø£Ø¶Ù Ù…Ø¹Ø±ÙÙƒ Ù‡Ù†Ø§)
        admin_list = [7640355263]  # Ø£Ø¶Ù Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
        if user_id in admin_list:
            is_admin = True
        
        if not is_admin:
            await update.message.reply_text(f"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·\nÙ…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: {user_id}")
            return
        
        await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        db_path = find_database_file()
        if not db_path:
            await update.message.reply_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return
        
        report_generator = WeeklyReportGenerator(db_path)
        success = report_generator.generate_and_send_weekly_report()
        
        if success:
            await update.message.reply_text("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­")
        else:
            await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±")
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {e}")
        await update.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {str(e)}")

async def report_status_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø£Ù…Ø± Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"""
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
        user_id = update.effective_user.id
        is_admin = False
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø©
        admin_id = os.getenv("ADMIN_USER_ID")
        if admin_id and str(user_id) == admin_id:
            is_admin = True
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if not is_admin:
            try:
                db_manager = context.bot_data.get("DB_MANAGER")
                if db_manager and hasattr(db_manager, 'is_user_admin'):
                    is_admin = db_manager.is_user_admin(user_id)
            except:
                pass
        
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ø£Ø¶Ù Ù…Ø¹Ø±ÙÙƒ Ù‡Ù†Ø§)
        admin_list = [7640355263]  # Ø£Ø¶Ù Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
        if user_id in admin_list:
            is_admin = True
        
        if not is_admin:
            await update.message.reply_text(f"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·\nÙ…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: {user_id}")
            return
        
        # ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        from weekly_report import is_email_configured
        
        status_msg = "ğŸ“Š Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©\n\n"
        
        # ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db_path = find_database_file()
        if db_path:
            status_msg += f"âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {db_path}\n"
        else:
            status_msg += "âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©\n"
        
        # ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        if is_email_configured():
            status_msg += "âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: Ù…ÙƒÙˆÙ†Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n"
        else:
            status_msg += "âŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ØºÙŠØ± Ù…ÙƒÙˆÙ†Ø©\n"
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
        status_msg += f"\nğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±:\n"
        status_msg += f"â€¢ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\n"
        status_msg += f"â€¢ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: {'âœ… Ù…Ø¯ÙŠØ±' if is_admin else 'âŒ ØºÙŠØ± Ù…Ø¯ÙŠØ±'}\n"
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
        status_msg += "\nğŸ“… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:\n"
        status_msg += "â€¢ Ø§Ù„ØªÙˆÙ‚ÙŠØª: ÙƒÙ„ ÙŠÙˆÙ… Ø£Ø­Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 9:00 ØµØ¨Ø§Ø­Ø§Ù‹\n"
        status_msg += "â€¢ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ\n"
        
        # Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©
        status_msg += "\nğŸ”§ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\n"
        status_msg += "â€¢ /generate_report - Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±ÙŠ\n"
        status_msg += "â€¢ /report_status - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©\n"
        
        await update.message.reply_text(status_msg)
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}")
        await update.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: {str(e)}")

def add_admin_report_commands(application, reporting_system):
    """Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ø¨ÙˆØª"""
    try:
        # Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ±
        application.add_handler(CommandHandler("generate_report", generate_report_command))
        application.add_handler(CommandHandler("report_status", report_status_command))
        
        logger.info("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­")
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}")

